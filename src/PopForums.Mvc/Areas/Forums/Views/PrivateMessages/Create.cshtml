@{
	ViewBag.Title = PopForums.Resources.NewPM;
	Layout = "~/Areas/Forums/Views/Shared/PopForumsMaster.cshtml";
}

@section HeaderContent
{
<script type="text/javascript" language="javascript">
	ready(() => {
		var toText = document.querySelector("#ToText");
		var toList = document.querySelector("#ToList");
		toText.addEventListener("keyup", () => {
			var q = toText.value;
			if (q.length > 1) {
				fetch(PopForums.areaPath + "/PrivateMessages/GetNames?id=" + q)
					.then(response => response.json())
					.then(result => {
						toList.innerHTML = "";
						result.forEach(item => {
							var t = document.createElement("template");
							t.innerHTML = '<li><a href="#" data-userID="' + item.userID + '" class="toItem">' + item.value + '</a></li>';
							toList.append(t.content.firstChild);
						});
					});
			} else
				toList.innerHTML = "";
		});

		document.addEventListener("click", e => {
			if (event.target.classList.contains("toItem")) {
				var item = e.target;
				var userID = item.getAttribute("data-userID");
				var label = '<div data-userID="' + userID + '" class="badge bg-primary toLabel">' + item.innerHTML + ' <span class="icon-cancel-circle toLabelX"></span></div>';
				var t = document.createElement("template");
				t.innerHTML = label;
				document.querySelector("#PMToBox").append(t.content.firstChild);
				toList.innerHTML = "";
				toText.value = "";
				var modal = bootstrap.Modal.getInstance(document.getElementById("ToModal"));
				modal.hide();
				serializeIDs();
			}
		});

		document.addEventListener("click", e => {
			if (event.target.classList.contains("toLabelX")) {
				event.target.parentElement.remove();
				serializeIDs();
			}
		});

		var modal = document.getElementById('ToModal');
		modal.addEventListener("shown.bs.modal", () => {
			document.querySelector("#ToText").focus();
		});
		
		serializeIDs();
	});

	function serializeIDs() {
		var items = document.querySelectorAll("#PMToBox div");
		var ids = [];
		items.forEach(item => { ids.push(item.getAttribute("data-userID")); });
		document.querySelector("#UserIDs").value = ids;
	}
</script>
}

<div>
	<h1>@PopForums.Resources.NewPM</h1>
	<ul id="TopBreadcrumb" class="breadcrumb">
		<li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@PopForums.Resources.Forums</a></li>
		<li class="breadcrumb-item"><a asp-action="Index">@PopForums.Resources.PrivateMessages</a></li>
	</ul>
</div>

@if (ViewBag.Warning != null)
{ <p class="alert alert-danger">@ViewBag.Warning</p> }

<div class="modal fade" id="ToModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">@PopForums.Resources.To</h4>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<input id="ToText" type="text" class="form-control" placeholder="@PopForums.Resources.Search" />
				<div id="ToResultList">
					<ul id="ToList" class="list-unstyled"></ul>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<form method="post">
	<input type="hidden" id="UserIDs" name="UserIDs"/>
	<div role="form">
		<div class="form-group">
			<label><input type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ToModal" value="@PopForums.Resources.To"/></label>
			<div id="PMToBox">
				@if (ViewBag.TargetUserID != null)
				{
					<div data-userid="@ViewBag.TargetUserID" class="badge bg-primary toLabel">@ViewBag.TargetUserName <span class="icon-cancel-circle toLabelX"></span></div>
				}
			</div>
		</div>
		<div class="form-group">
			<label for="Subject">@PopForums.Resources.Subject</label>
			<input type="text" id="Subject" name="Subject" class="form-control"/>
		</div>
		<div class="form-group">
			<label for="FullText">@PopForums.Resources.Message</label>
			<textarea id="FullText" name="FullText" class="form-control"></textarea>
		</div>
		<input id="SendButton" type="submit" value="@PopForums.Resources.Send" class="btn btn-primary"/>
	</div>
</form>