@model TopicContainer
@inject IUserRetrievalShim UserRetrievalShim
@{
	ViewBag.Title = Model.Topic.Title;
	Layout = "~/Areas/Forums/Views/Shared/PopForumsMaster.cshtml";
	var user = UserRetrievalShim.GetUser();
	var profile = UserRetrievalShim.GetProfile();
	var topicStateSerialized = JsonSerializer.Serialize((TopicState) ViewBag.TopicState, new JsonSerializerOptions{ PropertyNamingPolicy = JsonNamingPolicy.CamelCase });
}

@section HeaderContent {
	<script src="~/lib/tinymce/tinymce.min.js" type="text/javascript"></script>
	<script type="text/javascript">
		PopForums.currentTopicState = Object.assign(new PopForums.TopicState(), @Html.Raw(topicStateSerialized));
		PopForums.currentTopicState.setupTopic();
	</script>
}

<h1>@Model.Topic.Title</h1>

<ul id="TopBreadcrumb" class="breadcrumb sticky-top">
	<li class="breadcrumb-item"><a asp-controller="@ForumController.Name" asp-action="Recent" asp-route-pageNumber="">@PopForums.Resources.Recent</a></li>
	<li class="breadcrumb-item"><a asp-controller="@HomeController.Name" asp-action="Index">@PopForums.Resources.Forums</a></li>
	<li class="breadcrumb-item"><a asp-controller="Forum" asp-action="Index" asp-route-urlName="@Model.Forum.UrlName" asp-route-pageNumber="">@Model.Forum.Title</a></li>
	<li class="breadcrumb-item active">@Model.Topic.Title</li>
</ul>

@if (user != null) {
	<p id="AsyncResponse"></p>
	<div id="TopicTools">
		<pf-subscribebutton buttonclass="btn btn-primary" caller="PopForums.currentTopicState.isSubscribed" subscribetext="@PopForums.Resources.Subscribe" unsubscribetext="@PopForums.Resources.Unsubscribe"></pf-subscribebutton>
		<pf-favoritebutton buttonclass="btn btn-primary" caller="PopForums.currentTopicState.isFavorite" makefavoritetext="@PopForums.Resources.FavoriteMake" removefavoritetext="@PopForums.Resources.FavoriteRemove"></pf-favoritebutton>
		@if (user.IsInRole(PermanentRoles.Moderator))
		{
			<pf-topicmoderationlogbutton topicid="@Model.Topic.TopicID" buttontext="@PopForums.Resources.ModerationLog" buttonclass="btn btn-primary"></pf-topicmoderationlogbutton>
		}
	</div>
}

<pf-pagerLinks controllerName="Forum" actionName="Topic" pagerContext="@Model.PagerContext" class="pagination pagination-sm pagerLinks mt-3" moreTextClass="morePager" currentTextClass="currentPager active" />

@if (Model.PagerContext.PageIndex > 1)
{
	<pf-previouspostsbutton buttontext="@PopForums.Resources.ShowPreviousPosts" buttonclass="btn btn-primary" caller="PopForums.currentTopicState.lowPage"></pf-previouspostsbutton>
}

<div id="PostStream">

	@foreach(var post in Model.Posts) {
		@await Html.PartialAsync("~/Areas/Forums/Views/Forum/PostItem.cshtml", new PostItemContainer { Post = post, VotedPostIDs = Model.VotedPostIDs, Signatures = Model.Signatures, Avatars = Model.Avatars, User = user, Profile = profile, Topic = Model.Topic });
	}

</div>

<p><pf-morepostsbutton buttontext="@PopForums.Resources.ShowMorePosts" buttonclass="btn btn-primary my-3" caller="PopForums.currentTopicState.highPage"></pf-morepostsbutton></p>

<pf-pagerLinks controllerName="Forum" actionName="Topic" pagerContext="@Model.PagerContext" class="pagination pagination-sm pagerLinks" moreTextClass="morePager" currentTextClass="currentPager active" />

<div id="StreamBottom"></div>

@if (Model.PermissionContext.UserCanPost)
{
	<div id="NewReply"></div>
	<pf-replybutton buttonclass="btn btn-primary" buttontext="@PopForums.Resources.PostReply" topicid="@Model.Topic.TopicID" postid="" caller="PopForums.currentTopicState.isReplyLoaded"></pf-replybutton>
}
else
{
	<p class="alert alert-warning">@Model.PermissionContext.DenialReason</p>
}

@if (user != null && user.IsInRole(PermanentRoles.Moderator))
{
	<div id="ModeratorPanel" class="bg-light mt-3 p-3">
		<h3>@PopForums.Resources.Moderator</h3>
		<div class="form-check">
			<label for="CloseOnReply" class="form-check-label">@PopForums.Resources.CloseOnReply</label>
			@Html.CheckBox("CloseOnReply", new { @class = "form-check-input" })
		</div>
		<ul class="list-inline">
			<li class="list-inline-item">
				<form asp-action="ToggleDeleted" asp-controller="Moderator" asp-antiforgery="false" asp-route-id="@Model.Topic.TopicID" class="inlineModForm"><input type="submit" value="@(Model.Topic.IsDeleted ? PopForums.Resources.Undelete : PopForums.Resources.Delete)" class="btn btn-warning mt-2"/>
				</form></li>
			<li class="list-inline-item">
				<form asp-action="TogglePin" asp-controller="Moderator" asp-antiforgery="false" asp-route-id="@Model.Topic.TopicID" class="inlineModForm"><input type="submit" value="@(Model.Topic.IsPinned ? PopForums.Resources.Unpin : PopForums.Resources.Pin)" class="btn btn-warning mt-2"/>
				</form></li>
			<li class="list-inline-item">
				<form asp-action="ToggleClosed" asp-controller="Moderator" asp-antiforgery="false" asp-route-id="@Model.Topic.TopicID" class="inlineModForm"><input type="submit" value="@(Model.Topic.IsClosed ? PopForums.Resources.Open : PopForums.Resources.Close)" class="btn btn-warning mt-2"/>
				</form></li>
			@if (user.IsInRole(PermanentRoles.Admin))
			{
				<li class="list-inline-item">
					<form asp-action="DeleteTopicPermanently" asp-controller="Moderator" asp-antiforgery="false" asp-route-id="@Model.Topic.TopicID" class="inlineModForm"><input type="submit" value="@PopForums.Resources.DeletePermanently" class="btn btn-warning mt-2"/>
					</form></li>
			}
		</ul>
		<form asp-action="UpdateTopic" asp-controller="Moderator" asp-antiforgery="false" asp-route-id="@Model.Topic.TopicID" class="form-horizontal" role="form">
			@Html.Hidden("TopicID", Model.Topic.TopicID)
			<div class="mb-3">
				<label for="NewTitle" class="col-sm-2 form-label">@PopForums.Resources.Title</label>
				<div class="col-sm-6">
					@Html.TextBox("NewTitle", Model.Topic.Title, new {@class = "form-control"})
				</div>
			</div>
			<div class="mb-3">
				<label for="NewForum" class="col-sm-2 form-label">@PopForums.Resources.Forum</label>
				<div class="col-sm-6">
					<select id="NewForum" name="NewForum" class="form-select" asp-items="ViewBag.CategorizedForums"></select>
				</div>
			</div>
			<div class="mb-3">
				<div class="col-sm-6">
					<input type="submit" value="@PopForums.Resources.Update" class="btn btn-warning"/>
				</div>
			</div>
		</form>
	</div>
}